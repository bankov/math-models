\section{Аналитическая модель EDCA}
Имеется ad hoc сеть, состоящая из $N$ станций. Длины пакетов всех станций одинаковы и равны $L$. $K$ --- число категорий трафика внутри станций. $n_k$ --- число станций каждой категории. Предполагаем, что каждая станция передает трафик только одной категории.
\begin{itemize}
\item пропускная способность $S_k$,
\item вероятность $J_k$ сброса пакета ввиду достижения максимального числоа попыток,
\item среднее время $D_k$ передачи одного пакета.
\end{itemize}
Эти показатели связаны посредством формулы:
\begin{equation}
S_k = \frac{L(1-J_k)}{D_k}
\end{equation}

Согласно стандарту $AIFS[k] = SIFS + AIFSN[k]\cdot\sigma$, где $AIFSN[k] \geqslant 2$, $\forall k$, причем $DIFS = SIFS + 2\sigma$. Поэтому можно представить $AIFS[k]$ в следующем виде:
\begin{equation}
\notag
AIFS[k] = DIFS + (AIFSN[k]-2)\sigma = DIFS + AIFSN'[k]\cdot\sigma.
\end{equation} 
При этом для станций первой категории $AIFSN'[1] = 0$, т.~е. эти станции начинают отсчитывать слоты сразу по завершению $DIFS$. Поделим слоты на классы таким образом, что станция категории $k$ может начать передачу начиная со слота под номером $H_k+1$. Если условимся нумеровать слоты начиная от $1$, то получим следующие значения $H_k$:

\begin{tabular}{>{$}l<{$} >{$}l<{$} >{$}l<{$}}
H_1 &= &0 \\
H_2 &= &AIFSN'[2] \cdot \sigma \\
H_k &= &AIFSN'[k] \cdot \sigma \\
H_K &= &AIFSN'[K] \cdot \sigma \\
\end{tabular}

Таким образом, первые $H_2$ слотов доступны только для станций категории 1. Слоты под номерами $H_2+1$, \dots , $H_3$ доступны для станций категории 1 и 2 и т.д. Слоты под номерами $H_K+1$ и выше доступны для станций всех категорий.

Пусть $p_k$ --- вероятность того, что станция категории $k$ запланировала передачу в некотором слоте. Тогда $r_k = 1 - p_k$ --- вероятность отсутствия передачи этой станции в данном слоте. Вероятность того, что ни одна станция категории $k \leqslant j$ не выберет слот для передачи в классе $j$ равна $r_k^{n_k}$. Тогда вероятность
$c_k^{(j)}$ коллизии станции категории $k$ в классе $j$, $j \geqslant k$, определяется по формуле:
\begin{equation}
\notag
c_k^{(j)} = 1 - \frac{1}{r_k}\prod\limits_{i = 1}^{j} r_i^{n_i},
\end{equation} 
где $\frac{1}{r_k}\prod\limits_{i = 1}^{j} r_i^{n_i}$ есть вероятность того, что ни одна из оставшихся станций не выбрала данный слот на передачу.
Тогда вероятность $c_k$ коллизии станции категории $k$ вычисляется следующим образом:
\begin{equation}
\notag
c_k = \sum\limits_{j = k}^{K} c_k^{(j)} \frac{P_j}{\sum\limits_{i = k}^{K} P_i}, 
\end{equation}
где $P_j$ --- вероятность того, что произвольно выбранный слот принадлежит классу $j$.

\textbf{Вопрос} Для станций разных категорий должна быть свое распределение $\{P_j\}$, причем эти распределения не обязательно должны быть связаны так, как показано на сверху.


Рассмотрим цепь Маркова с состояниями $1$, $2$, \dots, $H_K+1$.
Если в вероятностью $\alpha_1 = r_1^{n_1}$ ни одна станция не выбрала первый слот, то переходим в состояние $2$. 

\begin{tabular}{l l l}
$\alpha_1$  &$=$ &$r_1^{n_1}$  \\
$\alpha_2$	&$=$ &$r_1^{n_1}r_2^{n_2}$ \\
$\alpha_3$	&$=$ &$r_1^{n_1}r_2^{n_2}r_3^{n_3}$ \\
\dots	&\dots	&\dots \\
$\alpha_k$	&$=$ &$\prod\limits_{i = 1}^{k} r_i^{n_i}$ \\
\dots	&\dots	&\dots \\
\end{tabular}

$\pi_1 = \pi_1$

$\pi_2 = \alpha_1 \pi_1$

$\pi_3 = \alpha_1^2 \pi_1$

$\pi_{H_2} = \alpha_1^{H_2-1} \pi_1$

$\pi_{H_2+1} = \alpha_1^{H_2} \pi_1$

$\pi_{H_2+2} = \alpha_2 \pi_{H_2+1}$

$\pi_{H_k} = \alpha_{k-1}^{H_k-H_{k-1}}$

\begin{equation}
P_k = \pi_{H_k+1} + \dots + \pi_{H_{k+1}} = \pi_{H_k+1} + \alpha_k \pi_{H_k+1} + \dots + \alpha_k^{H_{k+1}-H_k-1}\pi_{H_k+1} = \pi_{H_k+1} \frac{1-\alpha_k^{H_{k+1}-H_k}}{1-\alpha_k}
\end{equation}

\begin{eqnarray}
\pi_{H_{K}+1} & = & \alpha_{K-1}\pi_{H_{K}} + \alpha_{K} \pi_{H_{K+1}} \\
\pi_{H_{K}+1} & = & \frac{\alpha_{K-1}}{1-\alpha_{K}}\pi_{H_K}
\end{eqnarray}

Вероятность сброса пакета $J_k = c_k^{R+1}$. 
Пусть $F_k$ --- среднее число попыток передач одного пакета: $F_k = \sum\limits_{i = 0}^{R-1} (c_k)^r$. Пусть $W_k$ --- среднее число слотов на передачу одного пакета: $W_k = \sum\limits_{i=0}^{R-1} (c_k)^i \left(\frac{W_{i}-1}{2} + 1 \right) = \sum\limits_{i=0}^{R-1} (c_k)^i \frac{W_{i}+1}{2}$. Тогда среднее время передачи одного пакета вычисляется следующим образом:
\begin{equation}
\label{EDCA:Duratoon}
D_k = (1-J_k)T_{s,k} + (F_{k}-1+J_k)T_{c,k} + (W_k-F_k)T_{slot,k},
\end{equation}
где 
\begin{itemize}
\item $T_{s,k} = \overbrace{DATA + SIFS + ACK + DIFS}^{T} + IFS_k$ --- время успешной передачи пакета;
\item $T_{c,k} = DATA + t_{AckTimeout} + DIFS + IFS_k$ --- время коллизии;
\item $t_{AckTimeout} = SIFS + ACK$;
\item $T_{slot,k} = (1-c_k)\sigma + c_k(T+IFS_k)$ \textbf{Вопрос} куда делись успешные передачи других станций.
\item $IFS_k$ --- временной промежуток, между окончанием передачи или коллизии и временем начала отсчета счетчка отсрочки.
\end{itemize}
Поясним подробнее слагаемые в~\eqref{EDCA:Duratoon}. \dots

\begin{equation}
D_k = (F_k + (W_k-F_k)c_k)(T+IFS_k) + (W_k - F_k)(1-c_k)\sigma
\end{equation}

Обозначим через $\mu_i$ вероятность прерывания $i$-го слота. Тогда
\begin{equation}
\mu_i = (1-\alpha_{\varphi(i)})\prod\limits_{j = 1} ^{i-1} \alpha_{\varphi(j)},
\end{equation}
где $\varphi$ --- функция класса: $\varphi(i) = j, H_j < i \leqslant H_{j+1}$. При этом вероятность успешно отсчитать первые $H_k$ слотов равна 
\begin{equation}
S_k = 1 - \sum\limits_{i=1}^{H_k} \mu_i.
\end{equation}
Действительно, эта вероятность должа быть равна $\alpha_{\varphi(1)}\alpha_{\varphi(1)}\dots\alpha_{\varphi(H_k)}$, в чем можно убедиться раскрыв сумму.

За счет разницы в значениях AIFS-ов различных категорий, станции с данными меньших категорий начинают отсчет слотов раньше станций с данными больших категорий (все станции в сети слышат друг друга, а потому момент освобождения среди детектируется всеми станциями одновременно). Поэтому после окончания коллизии или успешной передачи какой-либо станции станции категории $k-1$ и ниже могут множество раз получить доступ к среде, прежде чем станции категории $k$ наконец то успеют выждать свой интервал $AIFS[k]$ и начать отсчет слотов. Поэтому интервал времени между отсчетами слотов станций категории $k$ может значительно превосходить времена $T_{c,k}$ коллизии и $T_{s,k}$ успешной передачи.

\begin{equation}
IFS_k = \mathbb{E}\{g(\vec{i}) = i_1T+i_2(T+\sigma) + \dots + i_{H_k}(T+(H_k-1)\sigma)\},
\end{equation}
где $i_j$ --- число передач, которые начинались в $j$-ом слоте, отсчитанном после окончания очередной передачи. Фиксируем $I=\sum\limits{j=1}^{k}i_j$ --- суммарное число передач, котрое произошло в пределах слотов с номерами $1$,$\dots$,$H_k$, т.~е. без участия станций категории $k$ и ниже.
Обозначим через $\pi(\vec{i}|I)$ --- вероятность распределения $\vec{i}$ числа попыток передач по слотам с номерами $1$, $\dots$, $H_k$ и суммарным числом попыток передач равным $I$.
\begin{equation}
\pi(\vec{i}|I) = \underbrace{\frac{I!}{\prod\limits_{j=1}^{H_k}i_j!}}_{\substack{\text{полиномиальный}\\ \text{коэффициент}}} S\prod\limits_{j=1}^{H_k} \mu_j^{i_j}.
\end{equation}
В силу условия нормировки $\sum\limits_{I = 0}^{\infty}\sum\limits_{\vec{i}\colon\sum\limits i_j = I}\pi(\vec{i}|J) = 1$, поэтому введя обозначение $\pi'=\frac{\pi}{S}$, получаем
\begin{equation}
\notag
J(\vec{\mu}) = \sum\limits_{I = 0}^{\infty}\sum\limits_{\vec{i}} \pi' = \frac{1}{S} = \frac{1}{1-\sum\limits_{j=1}^{H_k} \mu_j}.
\end{equation}
Откуда 
\begin{equation}
\notag
\sum\limits_{I = 0}^{\infty}\sum\limits_{\vec{i}} i_j\pi' = S\mu_j\frac{dJ}{d\mu_j}.
\end{equation}
\begin{gather}
IFS_k = H_k\sigma + \sum\limits_{I = 0}^{\infty} \sum\limits_{\vec{i}} \sum\limits_{j=1}^{H_k} [T+(j-1)\sigma]i_j\pi(\vec{i}|I) = \\ = H_k\sigma + 
S\sum\limits_{j=1}^{H_k}[T+(j-1)\sigma] \cdot \mu_j \underbrace{\frac{dJ}{d\mu_j}}_{\frac{1}{S^2}} = H_k \sigma + \sum\limits_{j=1}^{H_k}[T+(j-1)\sigma]\frac{\mu_j}{S}.
\end{gather}